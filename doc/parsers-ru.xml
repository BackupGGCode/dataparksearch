<sect1 id="pars">
	<title>Внешние парсеры
<indexterm><primary>Парсеры</primary></indexterm>
</title>

	<para><application>DataparkSearch</application> <command>indexer</command> может использовать внешние парсеры для
различных типов файлов (mime types).</para>

	<para>Парсер - это программа, которая конвертирует один из типов файла (mime type) в <literal>text/plain</literal> или
<literal>text/html</literal>. Например, если у вас есть PostScript файлы, Вы можете использовать парсер (фильтр)
<command>ps2ascii</command>, читающий из <literal>stdin</literal> PostScript файл и выдающий текст в ascci на <literal>stdout</literal>.
</para>

	<sect2 id="pars-sup">
		<title>Поддерживаемые типы парсеров</title>
		<para><command>Indexer</command> поддерживает четыре типа парсеров, такие что:</para>
		<itemizedlist>
			<listitem>
				<para>читают данные из <literal>stdin</literal> и выдают результат в <literal>stdout</literal>;</para>
			</listitem>
			<listitem>
				<para>читают данные из файла и выдают результат в <literal>stdout</literal>;</para>
			</listitem>
			<listitem>
				<para>читают данные из файла и помещают результат в файл;</para>
			</listitem>
			<listitem>
				<para>читают данные из <literal>stdin</literal> и помещают результат в файл.</para>
			</listitem>
		</itemizedlist>
	</sect2>

	<sect2 id="pars-setup">
		<title>Установка парсеров</title>
		<orderedlist numeration="arabic">
			<listitem>
				<para>Конфигурирование типов файлов (mime types)</para>
				<para>Сконфигурируйте Ваш веб-сервер на выдачу соответствующего заголовка
<literal>Content-Type</literal>. Например, для <application>apache</application>, смотрите файл <filename>mime.types</filename>,
большинство типов файлов уже указаны в нём.</para>

				<para>
<indexterm><primary>Команда</primary><secondary>AddType</secondary></indexterm>
Если необходимо индексировать файлы на локальной файловой системе, или используя протокол <literal>ftp</literal>
используйте команду <command>AddType</command> в
<filename>indexer.conf</filename> для привязки типа файла к расширению файлов. Например:
				<programlisting>
AddType text/html *.html
</programlisting>
				</para>
			</listitem>
			<listitem>
				<para>
<indexterm><primary>Команда</primary><secondary>Mime</secondary></indexterm>
Добавление парсеров</para>
				<para>Добавление строк с определениями парсеров. Эти строки имеюют следующий формат с треми аргументами:
				<programlisting>
Mime &lt;from_mime&gt; &lt;to_mime&gt; &lt;command line&gt;
</programlisting>
				</para>

				<para>Например, следующая строка определяет парсер для <application>man</application>-страниц:
				<programlisting>
# Use deroff for parsing man pages ( *.man )
Mime  application/x-troff-man   text/plain   deroff
</programlisting>
				</para>

				<para>Этот парсер будет получать данные из <literal>stdin</literal> и повещать результат в
<literal>stdout</literal>.</para>

				<para>Некоторые парсеры не могут работать с <literal>stdin</literal>, а требуют указания имени
файла для чтения данных. В этом случае <command>indexer</command> создаёт временный файл в директории <filename>/tmp</filename>,
который будет удалён после завершения работы парсера. Используйте макро <option>$1</option> в командной строке парсера вместо
требуемого имени файла. Например, команда <command>Mime</command>для конверотора <command>catdoc</command>, преобразующего файлы
<application>MS Word</application> в ascii может выглядеть так:
				<programlisting>
Mime application/msword text/plain "/usr/bin/catdoc -a $1"
</programlisting>
				</para>

				<para>Если парсер записывает результат своей работы в файл, используйте макро <option>$2</option>.
<command>indexer</command> заменить <option>$2</option> на имя временного файла, запустит парсер, 
прочитает результат из этого временного файла, а затем удалит его. Например:
				<programlisting>
Mime application/msword text/plain "/usr/bin/catdoc -a $1 >$2"
</programlisting>
				</para>

				<para>Парсер выше будет читать данные из первого временного файла и записывать результат во
второй временный файл. Оба временных файла будут удалены по окончании  работы парсера. Заметим, что результат использования
этого парсера будет абсолютно таким же, как и предыдущего, они отличаютя только сопсобом выполнения: 
файл-&gt;<literal>stdout</literal> и файл-&gt;файл соответственно.</para>

			</listitem>
		</orderedlist>
	</sect2>

<sect2 id="ParserTimeOut">
<title>Воизбежание зависания парсера при выполнении</title>
<para>
<indexterm><primary>Команда</primary><secondary>ParserTimeOut</secondary></indexterm>
Воизбежание подвисания парсера при выполнении Вы можете указать в Вашем файле <filename>indexer.conf</filename>
число времени в секундах, отводимое на работу парсеру, при помощи команды <literal>ParserTimeOut</literal>. Напрмиер:
		<programlisting>
ParserTimeOut 600
</programlisting>
</para>
<para>
Значение по умолчанию - 300 секунд, т.е. 5 минут.
</para>
</sect2>



	<sect2 id="pars-pipes">
		<title>Конвееры в командных строках парсеров</title>
		<para>Вы можете использовать конвееры в командных строках парсеров. Например, следующие строки необходимы
 при индексировании загнузипленых страниц <application>man</application> на локальном диске:
		<programlisting>
AddType  application/x-gzipped-man  *.1.gz *.2.gz *.3.gz *.4.gz
Mime     application/x-gzipped-man  text/plain  "zcat | deroff"
</programlisting>
		</para>
	</sect2>

	<sect2 id="pars-char">
		<title>Кодировки и парсеры
<indexterm><primary>Парсеры</primary><secondary>Кодировки</secondary></indexterm>
</title>
		<para>Некоторые парсеры могут выдавать результат в кодировке, отличной от указанной в
команда <command>LocalCharset</command>. Указание кодировки парсера даёт возможность <command>indexer</command>
перекодировать результат в нужную кодировку. Например, если <command>catdoc</command> сконфигурирован на вывод
результата в  windows-1251, а в <command>LocalCharset</command> указана кодировка koi8-r,
используйте следующую команду для парсера документов <application>MS Word</application>:
		<programlisting>
Mime  application/msword  "text/plain; charset=windows-1251" "catdoc -a $1"
</programlisting>
		</para>
	</sect2>

	<sect2 id="pars-udmurl">
		<title>Переменная окружения DPS_URL
<indexterm><primary>DPS_URL переменная окружения</primary></indexterm>
</title>
		<para>При выполнении парсера, <command>indexer</command> создаёт переменную окружения DPS_URL,
содержащую URL обрабатываемого документа. Вы можете использовать эту переменную в Ваших скриптах парсеров.</para>

	</sect2>

	<sect2 id="pars-links">
		<title>Некоторые внешние парсеры
<indexterm><primary>Парсеры</primary><secondary>сторонние</secondary></indexterm>
</title>
		<itemizedlist>
			<listitem>
				<para>RPM парсер от Mario Lang <email>lang@zid.tu-graz.ac.at</email></para>
<para>        /usr/local/bin/rpminfo:

<programlisting>
#!/bin/bash
/usr/bin/rpm -q --queryformat="&lt;html&gt;&lt;head&gt;&lt;title&gt;RPM: %{NAME} %{VERSION}-%{RELEASE}
(%{GROUP})&lt;/title&gt;&lt;meta name=\"description\" content=\"%{SUMMARY}\"&gt;&lt;/head&gt;&lt;body&gt;
%{DESCRIPTION}\n&lt;/body&gt;&lt;/html&gt;" -p $1
</programlisting>
</para>

        <para>indexer.conf:
<programlisting>
Mime application/x-rpm text/html "/usr/local/bin/rpminfo $1"
</programlisting>
</para>

        <para>Он даёт такую информацию об RPM:

<programlisting>
3. RPM: mysql 3.20.32a-3 (Applications/Databases) [4]
       Mysql is a SQL (Structured Query Language) database server.
       Mysql was written by Michael (monty) Widenius. See the CREDITS
       file in the distribution for more credits for mysql and related
       things....
       (application/x-rpm) 2088855 bytes
</programlisting>
</para>
			</listitem>
			<listitem>
				<para>
					<command>catdoc</command> конвертер <application>MS Word</application> в текст.
					<ulink url="http://freshmeat.net/redir/catdoc/1055/url_homepage/">Home page</ulink>,
					также указан на <ulink url="http://freshmeat.net/">Freshmeat</ulink>
					<programlisting>indexer.conf: Mime application/msword  text/plain  "catdoc $1"</programlisting>
				</para>
			</listitem>
			<listitem>
				<para>
					<command>xls2csv</command> конвертор <application>MS Excel</application> в текст.
					Поставляется в пакете <command>catdoc</command>.
					<programlisting>indexer.conf: Mime application/vnd.ms-excel text/plain "xls2csv $1"</programlisting>
				</para>
			</listitem>
			<listitem>
				<para>
					<command>pdftotext</command> конвертор <application>Adobe PDF</application> в текст.
					Поставляется в пакете <command>xpdf</command>.
					<ulink url="http://freshmeat.net/redir/xpdf/12080/url_homepage/">Homepage</ulink>,
					также указан на <ulink url="http://freshmeat.net/">Freshmeat</ulink>
					<programlisting>indexer.conf: Mime application/pdf text/plain "pdftotext $1 -"</programlisting>
				</para>
			</listitem>
			<listitem>

				<para>
					<command>unrtf</command> конвертор RTF в html.
					<ulink url="ftp://ftp.gnu.org/pub/gnu/unrtf/">Homepage</ulink>
<programlisting>
indexer.conf:
Mime text/rtf*        text/html "/usr/local/dpsearch/sbin/unrtf --html $1
Mime application/rtf  text/html "/usr/local/dpsearch/sbin/unrtf --html $1
</programlisting>
				</para>
			</listitem>
			<listitem>
				<para><command>xlhtml</command> конверотор XLS в html</para>
				<para>
					<ulink url="http://chicago.sourceforge.net/xlhtml/">Homepage</ulink>
</para>
        <para><filename>indexer.conf</filename>:
				<programlisting>

Mime	application/vnd.ms-excel  text/html  "/usr/local/dpsearch/sbin/xlhtml $1"
</programlisting>
</para>
			</listitem>
			<listitem>
				<para><command>ppthtml</command> Конвертор PowerPoint (PPT) в html. Часть проекта <application>xlhtml 0.5</application>.</para>
				<para>
					<ulink url="http://chicago.sourceforge.net/xlhtml/">Homepage</ulink>
</para>
        <para><filename>indexer.conf</filename>:
				<programlisting>

Mime	application/vnd.ms-powerpoint  text/html  "/usr/local/dpsearch/sbin/ppthtml $1"
</programlisting>
</para>
			</listitem>
			<listitem>
				<para>Использование <ulink url="http://wvWare.sourceforge.net/">vwHtml</ulink> Конвертор MS Word (DOC) в html.</para>
				<para><filename>/usr/local/dpsearch/sbin/0vwHtml.pl</filename>:
				<programlisting>
#!/usr/bin/perl -w

$p = $ARGV[1];
$f = $ARGV[1];

$p =~ s/(.*)\/([^\/]*)/$1\//;
$f =~ s/(.*)\/([^\/]*)/$2/;

system("/usr/local/bin/wvHtml --targetdir=$p $ARGV[0] $f");
</programlisting>
</para>
        <para><filename>indexer.conf</filename>:
				<programlisting>

Mime  application/msword       text/html  "/usr/local/dpsearch/sbin/0wvHtml.pl $1 $2"
Mime  application/vnd.ms-word  text/html  "/usr/local/dpsearch/sbin/0wvHtml.pl $1 $2"
</programlisting>
</para>
			</listitem>
			<listitem>
				<para><command>swf2html</command> из 
<ulink url="http://www.macromedia.com/software/flash/download/search_engine/">Flash Search Engine SDK</ulink>
</para>
        <para><filename>indexer.conf</filename>:
				<programlisting>

Mime  application/x-shockwave-flash  text/html  "/usr/local/dpsearch/sbin/swf2html $1"
</programlisting>
</para>
			</listitem>
			<listitem>
				<para>djvutxt из 
<ulink url="http://djvu.sourceforge.net/">djvuLibre</ulink>
</para>
        <para><filename>indexer.conf</filename>:
				<programlisting>

Mime  image/djvu  text/plain  "/usr/local/bin/djvutxt $1 $2"
Mime  image/x.djvu  text/plain  "/usr/local/bin/djvutxt $1 $2"
Mime  image/x-djvu  text/plain  "/usr/local/bin/djvutxt $1 $2"
Mime  image/vnd.djvu  text/plain  "/usr/local/bin/djvutxt $1 $2"
</programlisting>
</para>
			</listitem>



		</itemizedlist>

	<para>Пожалуйста, присылайте Ваши скрипты и конфигурации для новых парсеров на адрес 
<email>dataparksearch@datapark.ru</email>.</para>

	</sect2>
</sect1>
